<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de Administración - Noticias</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 1rem auto;
      padding: 1rem;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    form {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    label {
      display: block;
      margin-top: 0.5rem;
      font-weight: bold;
    }
    input[type="text"], input[type="time"], input[type="date"], textarea, select {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .news-list {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .news-item {
      border-bottom: 1px solid #ddd;
      padding: 0.5rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .news-item:last-child {
      border-bottom: none;
    }
    .news-title {
      font-weight: bold;
      flex-grow: 1;
      margin-left: 10px;
    }
    .news-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
    }
    .btn-edit, .btn-delete {
      margin-left: 0.5rem;
      padding: 0.3rem 0.6rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-edit {
      background: #28a745;
      color: white;
    }
    .btn-edit:hover {
      background: #1e7e34;
    }
    .btn-delete {
      background: #dc3545;
      color: white;
    }
    .btn-delete:hover {
      background: #a71d2a;
    }
  </style>
</head>
<body>
  <h1>Panel de Administración - Publicaciones</h1>

  <form id="news-form">
    <input type="hidden" id="news-id" />
    
    <label for="titulo">Título</label>
    <input type="text" id="titulo" required />

    <label for="lugar">Lugar</label>
    <select id="lugar" required>
        <option value="">-- Selecciona una provincia --</option>
        <option value="Azua">Azua</option>
        <option value="Bahoruco">Bahoruco</option>
        <option value="Barahona">Barahona</option>
        <option value="Dajabón">Dajabón</option>
        <option value="Distrito Nacional">Distrito Nacional</option>
        <option value="Duarte">Duarte</option>
        <option value="El Seibo">El Seibo</option>
        <option value="Elías Piña">Elías Piña</option>
        <option value="Espaillat">Espaillat</option>
        <option value="Hato Mayor">Hato Mayor</option>
        <option value="Hermanas Mirabal">Hermanas Mirabal</option>
        <option value="Independencia">Independencia</option>
        <option value="La Altagracia">La Altagracia</option>
        <option value="La Romana">La Romana</option>
        <option value="La Vega">La Vega</option>
        <option value="María Trinidad Sánchez">María Trinidad Sánchez</option>
        <option value="Monseñor Nouel">Monseñor Nouel</option>
        <option value="Monte Plata">Monte Plata</option>
        <option value="Montecristi">Montecristi</option>
        <option value="Pedernales">Pedernales</option>
        <option value="Peravia">Peravia</option>
        <option value="Puerto Plata">Puerto Plata</option>
        <option value="Samaná">Samaná</option>
        <option value="San Cristóbal">San Cristóbal</option>
        <option value="San José de Ocoa">San José de Ocoa</option>
        <option value="San Juan">San Juan</option>
        <option value="San Pedro de Macorís">San Pedro de Macorís</option>
        <option value="Sánchez Ramírez">Sánchez Ramírez</option>
        <option value="Santiago">Santiago</option>
        <option value="Santiago Rodríguez">Santiago Rodríguez</option>
        <option value="Santo Domingo">Santo Domingo</option>
        <option value="Valverde">Valverde</option>
    </select>

    <label for="hora">Hora</label>
    <input type="time" id="hora" required />

    <label for="fecha">Fecha</label>
    <input type="date" id="fecha" required />

    <label for="tipo">Tipo</label>
    <select id="tipo" required>
      <option value="">-- Selecciona --</option>
      <option value="evento">Evento</option>
      <option value="noticia">Noticia</option>
      <option value="alerta">Alerta</option>
      <option value="cultura">Cultura</option>
      <option value="deportes">Deportes</option>
      <!-- Agrega más tipos según tu colección de PocketBase -->
    </select>

    <label for="imagen">Imagen (opcional)</label>
    <input type="file" id="imagen" accept="image/*" />

    <button type="submit">Guardar noticia</button>
  </form>

  <section class="news-list" id="news-list">
    <h2>Noticias existentes</h2>
    <div id="news-items">
      <!-- Aquí aparecerán las noticias -->
    </div>
  </section>

  <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
  <script>
    const pb = new PocketBase('http://127.0.0.1:8090'); // Cambia si tienes PocketBase en otro host

    const form = document.getElementById('news-form');
    const newsList = document.getElementById('news-items');

    // Cargar noticias existentes
    async function loadNews() {
      newsList.innerHTML = 'Cargando...';
      try {
        const records = await pb.collection('publicaciones').getFullList(200, {
          sort: '-created',
        });
        if(records.length === 0){
          newsList.innerHTML = '<p>No hay noticias aún.</p>';
          return;
        }
        newsList.innerHTML = '';
        records.forEach(item => {
          let imageUrl = '';
          if (item.imagen) {
            imageUrl = pb.files.getUrl(item, item.imagen, { thumb: '50x50' });
          }
          const div = document.createElement('div');
          div.className = 'news-item';
          div.innerHTML = `
            ${imageUrl ? `<img src="${imageUrl}" alt="${item.titulo}">` : ''}
            <span class="news-title">${item.titulo}</span>
            <div>
              <button class="btn-edit" data-id="${item.id}">Editar</button>
              <button class="btn-delete" data-id="${item.id}">Borrar</button>
            </div>
          `;
          newsList.appendChild(div);
        });

        // Agregar eventos a botones
        document.querySelectorAll('.btn-edit').forEach(btn => {
          btn.onclick = () => editNews(btn.dataset.id);
        });
        document.querySelectorAll('.btn-delete').forEach(btn => {
          btn.onclick = () => deleteNews(btn.dataset.id);
        });

      } catch (error) {
        newsList.innerHTML = `<p>Error al cargar noticias: ${error.message}</p>`;
      }
    }

    // Editar noticia
    async function editNews(id) {
      try {
        const record = await pb.collection('publicaciones').getOne(id);
        document.getElementById('news-id').value = record.id;
        document.getElementById('titulo').value = record.titulo || '';
        document.getElementById('lugar').value = record.lugar || '';
        document.getElementById('hora').value = record.hora || '';
        document.getElementById('fecha').value = record.fecha || '';
        document.getElementById('tipo').value = record.tipo || '';
        // No rellenamos la imagen porque es file input
        window.scrollTo(0, 0);
      } catch (error) {
        alert('Error al cargar la noticia para editar: ' + error.message);
      }
    }

    // Borrar noticia
    async function deleteNews(id) {
      if (!confirm('¿Seguro que quieres borrar esta noticia?')) return;
      try {
        await pb.collection('publicaciones').delete(id);
        loadNews();
      } catch (error) {
        alert('Error al borrar la noticia: ' + error.message);
      }
    }

    // Guardar noticia nueva o actualizada
    form.onsubmit = async (e) => {
      e.preventDefault();
      const id = document.getElementById('news-id').value;
      const titulo = document.getElementById('titulo').value.trim();
      const lugar = document.getElementById('lugar').value.trim();
      const hora = document.getElementById('hora').value.trim();
      const fecha = document.getElementById('fecha').value.trim();
      const tipo = document.getElementById('tipo').value;
      const imagenInput = document.getElementById('imagen');

      if (!titulo || !lugar || !hora || !fecha || !tipo) {
        alert('Por favor completa todos los campos requeridos.');
        return;
      }

      const formData = new FormData();
      formData.append('titulo', titulo);
      formData.append('lugar', lugar);
      formData.append('hora', hora);
      formData.append('fecha', fecha);
      formData.append('tipo', tipo);

      if (imagenInput.files.length > 0) {
        formData.append('imagen', imagenInput.files[0]);
      }

      try {
        if (id) {
          // Actualizar noticia
          await pb.collection('publicaciones').update(id, formData);
          alert('Noticia actualizada');
        } else {
          // Crear nueva noticia
          await pb.collection('publicaciones').create(formData);
          alert('Noticia creada');
        }
        form.reset();
        document.getElementById('news-id').value = '';
        loadNews();
      } catch (error) {
        alert('Error al guardar la noticia: ' + error.message);
      }
    };

    // Carga inicial
    loadNews();
  </script>
</body>
</html>